<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="route.html">

<!--
TODO(nevir): Document.
-->
<polymer-element name="more-route-context-aware">
  <script>
    Polymer('more-route-context-aware', {

      /** @override */
      ready: function() {
        // We want to execute this as soon as possible, but async so that other
        // routing contexts can set themselves up properly.
        var whenReady = (function() {
          if (this.routingIsReady) return;
          this.parentRoute = this._findParentRoute();
          this.routingIsReady = true;
          this.routingReady();
        }).bind(this);

        // So, we queue ourselves up with all the various ways of calling
        // something async, and let the first one win.
        Polymer.endOfMicrotask(whenReady);  // Probably.
        this.async(whenReady);
        setTimeout(whenReady, 0);
      },

      /**
       * Extension point for subclasses. They can assume that the element has
       * been initialized by this point.
       */
      routingReady: function() {},

      _findParentRoute: function() {
        var node = this;
        while (node) {
          node = node.parentNode || node.host;
          var route = node && (node.moreRouteContext || node.route);
          if (route instanceof MoreRouting.Route) {
            return route;
          }
        }
        return null;
      },

    });
  </script>
</polymer-element>
